# --------------------------------------------------------------------------
# Base: Ubuntu 20.04 + ROS Noetic + Gazebo Classic
# --------------------------------------------------------------------------
FROM osrf/ros:noetic-desktop-full

ENV DEBIAN_FRONTEND=noninteractive
SHELL ["/bin/bash", "-lc"]

# --------------------------------------------------------------------------
# System tools, Python basics, ROS tools, MoveIt
# --------------------------------------------------------------------------
RUN apt-get update && apt-get install -y --no-install-recommends \
    software-properties-common \
    python3-pip \
    python3-venv \
    git \
    curl \
    python3-rosdep \
    vim \
    less \
    ros-noetic-moveit \
    ros-noetic-ros-control \
    ros-noetic-ros-controllers \
    ros-noetic-effort-controllers \
    ros-noetic-rqt-robot-steering \
    ros-noetic-teleop-twist-keyboard \
    ros-noetic-joint-state-publisher-gui \
    mesa-utils \
 && rm -rf /var/lib/apt/lists/*

# --------------------------------------------------------------------------
# Install Python 3.9 (deadsnakes PPA)
# --------------------------------------------------------------------------
RUN add-apt-repository ppa:deadsnakes/ppa -y \
 && apt-get update && apt-get install -y --no-install-recommends \
    python3.9 \
    python3.9-venv \
    python3.9-distutils \
 && rm -rf /var/lib/apt/lists/*

# --------------------------------------------------------------------------
# Create Python 3.9 venv and install ROSA (jpl-rosa)
# --------------------------------------------------------------------------
ENV ROSA_VENV=/opt/rosa-venv

RUN python3.9 -m venv "${ROSA_VENV}" \
 && source "${ROSA_VENV}/bin/activate" \
 && pip install --upgrade pip \
 && pip install -U jpl-rosa \
 && pip install langchain-openai langchain-google-genai langchain-core python-dotenv

# --------------------------------------------------------------------------
# Initialize rosdep
# --------------------------------------------------------------------------
RUN rosdep update || (rosdep init && rosdep update)

# --------------------------------------------------------------------------
# Create catkin workspace and clone LIMO COBOT sim repo
# --------------------------------------------------------------------------
ENV CATKIN_WS=/root/catkin_ws
WORKDIR ${CATKIN_WS}

RUN mkdir -p src
WORKDIR ${CATKIN_WS}/src

RUN git clone https://github.com/agilexrobotics/limo_cobot_sim.git

# --------------------------------------------------------------------------
# Install dependencies via rosdep
# --------------------------------------------------------------------------
WORKDIR ${CATKIN_WS}

RUN source /opt/ros/noetic/setup.bash \
 && rosdep install --from-paths src --ignore-src -r -y

# --------------------------------------------------------------------------
# Build catkin workspace
# --------------------------------------------------------------------------
RUN source /opt/ros/noetic/setup.bash \
 && catkin_make

# --------------------------------------------------------------------------
# Convenience: source ROS, workspace, and ROSA in interactive shells
# --------------------------------------------------------------------------
RUN echo "source /opt/ros/noetic/setup.bash" >> /root/.bashrc \
 && echo "source /root/catkin_ws/devel/setup.bash" >> /root/.bashrc \
 && echo "source ${ROSA_VENV}/bin/activate" >> /root/.bashrc

# --------------------------------------------------------------------------
# Set PYTHONPATH for ROSA tools
# --------------------------------------------------------------------------
 ENV PYTHONPATH=/src/tools:${PYTHONPATH}

# --------------------------------------------------------------------------
# Force software rendering for OpenGL in container (Gazebo & RViz)
# --------------------------------------------------------------------------
ENV LIBGL_ALWAYS_SOFTWARE=1

# --------------------------------------------------------------------------
# Default: start LIMO COBOT simulation in Gazebo Classic
# --------------------------------------------------------------------------
CMD ["bash", "-lc", "source /root/catkin_ws/devel/setup.bash && roslaunch limo_cobot_moveit demo_gazebo.launch"]
